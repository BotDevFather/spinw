name: Spin Wheel Video

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            ffmpeg \
            chromium-browser \
            jq \
            curl

      # ----------------------------------
      # CREATE users.json (ARRAY ONLY)
      # ----------------------------------
      - name: Write users.json
        run: |
          echo '${{ toJson(github.event.client_payload.users) }}' > users.json
          cat users.json

      # ----------------------------------
      # START DISPLAY
      # ----------------------------------
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 500x500x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      # ----------------------------------
      # LAUNCH CHROMIUM WITH WATERMARK
      # ----------------------------------
      - name: Launch Spin Wheel
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-gpu \
            --window-size=500,650 \
            --window-position=0,0 \
            "file://$PWD/your_html_file.html?text=${{ github.event.client_payload.watermark }}" &
          sleep 4

      # ----------------------------------
      # RECORD VIDEO
      # ----------------------------------
      - name: Record Spin
        run: |
          ffmpeg -y \
            -video_size 500x650 \
            -framerate 30 \
            -f x11grab \
            -i :99.0+0,0 \
            -t 8 \
            -pix_fmt yuv420p \
            spin.mp4

      # ----------------------------------
      # SEND TO TELEGRAM
      # ----------------------------------
      - name: Send to Telegram
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ github.event.client_payload.botToken }}/sendVideo" \
            -F chat_id="${{ github.event.client_payload.chatId }}" \
            -F video=@spin.mp4 \
            -F caption="ðŸŽ¡ Spin Result"

      # ----------------------------------
      # OPTIONAL ARTIFACT
      # ----------------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spin-video
          path: spin.mp4
          
