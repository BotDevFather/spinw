name: Spin Wheel Render & Send

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            ffmpeg \
            chromium-browser \
            curl

      # -----------------------------
      # START DISPLAY
      # -----------------------------
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 500x650x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      # -----------------------------
      # LAUNCH CHROMIUM WITH PAYLOAD
      # -----------------------------
      - name: Launch Spin Wheel
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-gpu \
            --window-size=500,650 \
            --window-position=0,0 \
            --disable-infobars \
            --app="data:text/html,\
            <script>\
            window.__SPIN_PAYLOAD__ = { \
              users: ${{ toJson(github.event.client_payload.users) }}, \
              watermark: '${{ github.event.client_payload.watermark }}' \
            };\
            </script>\
            $(cat index.html)" &
          sleep 4

      # -----------------------------
      # RECORD VIDEO
      # -----------------------------
      - name: Record spin
        run: |
          ffmpeg -y \
            -video_size 500x650 \
            -framerate 30 \
            -f x11grab \
            -i :99.0+0,0 \
            -t 8 \
            -pix_fmt yuv420p \
            spin.mp4

      # -----------------------------
      # SEND TO TELEGRAM
      # -----------------------------
      - name: Send to Telegram
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ github.event.client_payload.botToken }}/sendVideo" \
            -F chat_id="${{ github.event.client_payload.chatId }}" \
            -F video=@spin.mp4 \
            -F caption="ðŸŽ¡ Spin Result"
