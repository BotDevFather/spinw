name: Spin Wheel Video

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repo
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick jq curl bc

      # ----------------------------
      # Download avatars from YOUR API response
      # ----------------------------
      - name: Download user images
        run: |
          set -e
          mkdir -p avatars

          USERS='${{ toJson(github.event.client_payload.users) }}'

          COUNT=$(echo "$USERS" | jq length)
          if [ "$COUNT" -lt 2 ]; then
            echo "Need at least 2 users"
            exit 1
          fi

          echo "$USERS" | jq -r '.[] | .photo_url' | nl -w1 -s':' | while read line; do
            IDX=$(echo "$line" | cut -d: -f1)
            URL=$(echo "$line" | cut -d: -f2-)

            echo "Downloading $URL"
            curl -L --fail "$URL" -o avatars/$IDX.jpg

            # Validate image
            identify avatars/$IDX.jpg >/dev/null 2>&1 || {
              echo "Invalid image: $URL"
              exit 1
            }
          done

      # ----------------------------
      # Build wheel image
      # ----------------------------
      - name: Build wheel image
        run: bash scripts/build_wheel.sh

      # ----------------------------
      # Pick winner
      # ----------------------------
      - name: Pick winner
        run: |
          COUNT=$(ls avatars | wc -l)
          WIN=$((RANDOM % COUNT))
          echo "WINNER=$WIN" >> $GITHUB_ENV
          echo "COUNT=$COUNT" >> $GITHUB_ENV

          echo "Winner index: $WIN / $COUNT"

      # ----------------------------
      # Render spin video (slow + stop)
      # ----------------------------
      - name: Render spin video
        run: |
          DURATION=3
          FULL_SPINS=4

          SLICE_ANGLE=$(echo "360 / $COUNT" | bc -l)

          # EXACT match with your UI logic
          FINAL_ROTATION=$(echo "$FULL_SPINS*360 + (360 - ($WINNER*$SLICE_ANGLE) - ($SLICE_ANGLE/2))" | bc)

          ffmpeg -y -loop 1 -i wheel.png \
            -filter_complex "
            rotate='(1 - pow(1 - t/$DURATION, 3)) * $FINAL_ROTATION * PI/180':c=none,
            drawbox=x=530:y=20:w=20:h=60:color=red:t=fill
            " \
            -t $DURATION \
            -r 30 \
            -pix_fmt yuv420p \
            output.mp4

      # ----------------------------
      # Send video to Telegram
      # ----------------------------
      - name: Send video to Telegram
        env:
          BOT_TOKEN: ${{ github.event.client_payload.botToken }}
        run: |
          CHAT_ID="${{ github.event.client_payload.chatid }}"
          RAW_DATA="${{ github.event.client_payload }}"
          echo "Sending video to chat $CHAT_ID $RAW_DATA"

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendVideo" \
            -F chat_id="$CHAT_ID" \
            -F video=@output.mp4

      # ----------------------------
      # Cleanup
      # ----------------------------
      - name: Cleanup
        run: |
          rm -rf avatars wheel.png output.mp4
          
