name: Spin Wheel Render & Send

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # CHECKOUT
      # -----------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # -----------------------------
      # INSTALL SYSTEM DEPENDENCIES
      # -----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            xvfb \
            ffmpeg \
            chromium-browser \
            jq \
            curl

      # -----------------------------
      # CREATE users.json (ARRAY ONLY)
      # -----------------------------
      - name: Create users.json
        run: |
          echo '${{ toJson(github.event.client_payload.users) }}' > users.json
          echo "users.json created:"
          cat users.json

      # -----------------------------
      # START VIRTUAL DISPLAY (FIXED)
      # -----------------------------
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 500x650x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 2

      # -----------------------------
      # LAUNCH CHROMIUM WITH WATERMARK
      # -----------------------------
      - name: Launch Spin Wheel HTML
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-gpu \
            --window-size=500,650 \
            --window-position=0,0 \
            "file://$PWD/index.html?text=${{ github.event.client_payload.watermark }}" &
          sleep 4

      # -----------------------------
      # RECORD USING FFMPEG (FIXED)
      # -----------------------------
      - name: Record spin video
        run: |
          ffmpeg -y \
            -video_size 500x650 \
            -framerate 30 \
            -f x11grab \
            -i :99.0+0,0 \
            -t 8 \
            -pix_fmt yuv420p \
            spin.mp4

      # -----------------------------
      # SEND VIDEO TO TELEGRAM
      # -----------------------------
      - name: Send video to Telegram
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ github.event.client_payload.botToken }}/sendVideo" \
            -F chat_id="${{ github.event.client_payload.chatId }}" \
            -F video=@spin.mp4 \
            -F caption="ðŸŽ¡ Spin Result"

      # -----------------------------
      # UPLOAD ARTIFACT (OPTIONAL)
      # -----------------------------
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spin-video
          path: spin.mp4
          
