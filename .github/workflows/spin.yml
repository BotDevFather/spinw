name: Spin Wheel Generator

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repo
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick curl bc

      # ----------------------------
      # Generate wheel image
      # ----------------------------
      - name: Generate spin wheel
        run: |
          chmod +x spin_wheel.sh

          USERS='${{ toJson(github.event.client_payload.users) }}'

          # Extract photo URLs into args
          URLS=$(echo "$USERS" | jq -r '.[].photo_url' | tr '\n' ' ')

          echo "Using URLs:"
          echo "$URLS"

          ./spin_wheel.sh $URLS

      # ----------------------------
      # Send image to Telegram
      # ----------------------------
      - name: Send wheel to Telegram
        env:
          BOT_TOKEN: ${{ github.event.client_payload.botToken }}
          CHAT_ID: ${{ github.event.client_payload.chatid }}
        run: |
          echo "Sending wheel.png to chat $CHAT_ID"

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendPhoto" \
            -F chat_id="$CHAT_ID" \
            -F photo=@wheel.png \
            -F caption="ðŸŽ¡ Spin Wheel Generated"
