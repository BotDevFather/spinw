name: Spin Wheel Video

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get install -y ffmpeg imagemagick jq curl

      - name: Fetch avatars
        run: |
          BOT="${{ github.event.client_payload.botToken }}"
          IDS='${{ toJson(github.event.client_payload.userIds) }}'
          bash scripts/fetch_avatars.sh $BOT $(echo $IDS | jq -r '.[]')

      - name: Build wheel
        run: bash scripts/build_wheel.sh

      - name: Spin
        run: |
          COUNT=$(ls avatars | wc -l)
          WIN=$((RANDOM % COUNT))
          bash scripts/spin_video.sh $WIN $COUNT

      - name: Send to Telegram
        run: |
          BOT="${{ github.event.client_payload.botToken }}"
          CHAT="${{ github.event.client_payload.chatid }}"
          bash scripts/send_telegram.sh $BOT $CHAT

      - name: Cleanup
        run: rm -rf avatars wheel.png output.mp4
        
