name: Spin Wheel Video

on:
  repository_dispatch:
    types: [spin]

jobs:
  render:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repo
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick jq curl bc

      # ----------------------------
      # Fetch Telegram avatars (JPG only)
      # ----------------------------
      - name: Fetch Telegram avatars
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          set -e
          mkdir -p avatars

          IDS='${{ toJson(github.event.client_payload.userIds) }}'
          echo "User IDs: $IDS"

          echo "$IDS" | jq -r '.[]' | while read id; do
            echo "Fetching avatar for $id"

            # Get profile photos
            RESP=$(curl -s "https://api.telegram.org/bot$BOT_TOKEN/getUserProfilePhotos?user_id=$id&limit=1")
            FILE_ID=$(echo "$RESP" | jq -r '.result.photos[0][-1].file_id // empty')

            if [ -z "$FILE_ID" ]; then
              echo "No avatar for $id"
              continue
            fi

            # Get file path
            FILE_PATH=$(curl -s \
              "https://api.telegram.org/bot$BOT_TOKEN/getFile?file_id=$FILE_ID" \
              | jq -r '.result.file_path // empty')

            if [ -z "$FILE_PATH" ]; then
              echo "Invalid file path for $id"
              continue
            fi

            # Download JPG safely
            curl -L --retry 3 --fail \
              "https://api.telegram.org/file/bot$BOT_TOKEN/$FILE_PATH" \
              -o avatars/$id.jpg

            # HARD VALIDATION
            if ! identify avatars/$id.jpg >/dev/null 2>&1; then
              echo "Corrupted JPG for $id"
              rm -f avatars/$id.jpg
              exit 1
            fi

            echo "Avatar OK for $id"
          done

      # ----------------------------
      # Debug avatars (remove later)
      # ----------------------------
      - name: Debug avatars
        run: |
          ls -lh avatars
          file avatars/*.jpg
          identify avatars/*.jpg

      # ----------------------------
      # Build wheel image
      # ----------------------------
      - name: Build wheel image
        run: |
          bash scripts/build_wheel.sh

      # ----------------------------
      # Pick winner
      # ----------------------------
      - name: Pick winner
        run: |
          COUNT=$(ls avatars | wc -l)
          if [ "$COUNT" -lt 2 ]; then
            echo "Need at least 2 avatars"
            exit 1
          fi

          WIN=$((RANDOM % COUNT))
          echo "WINNER=$WIN" >> $GITHUB_ENV
          echo "COUNT=$COUNT" >> $GITHUB_ENV

          echo "Winner index: $WIN"

      # ----------------------------
      # Render spin video (slow + stop)
      # ----------------------------
      - name: Render spin video
        run: |
          DURATION=3
          FULL_SPINS=4

          SLICE_ANGLE=$(echo "360 / $COUNT" | bc -l)

          # EXACT match with your HTML logic
          FINAL_ROTATION=$(echo "$FULL_SPINS*360 + (360 - ($WINNER*$SLICE_ANGLE) - ($SLICE_ANGLE/2))" | bc)

          echo "Final rotation: $FINAL_ROTATION"

          ffmpeg -y -loop 1 -i wheel.png \
            -filter_complex "
            rotate='(1 - pow(1 - t/$DURATION, 3)) * $FINAL_ROTATION * PI/180':c=none,
            drawbox=x=530:y=20:w=20:h=60:color=red:t=fill
            " \
            -t $DURATION \
            -r 30 \
            -pix_fmt yuv420p \
            output.mp4

      # ----------------------------
      # Send video to Telegram
      # ----------------------------
      - name: Send video to Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          CHAT_ID="${{ github.event.client_payload.chatid }}"
          echo "Sending video to chat $CHAT_ID"

          curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendVideo" \
            -F chat_id="$CHAT_ID" \
            -F video=@output.mp4

      # ----------------------------
      # Cleanup
      # ----------------------------
      - name: Cleanup
        run: |
          rm -rf avatars wheel.png output.mp4
          
