<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin Wheel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #ffffff;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .wheel-container {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto 0px;
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 0 15px #f0f0f0, 0 0 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.05s linear; /* Smoother animation */
        }

        .wheel-sector {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .sector-content {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            transform-origin: center;
            width: 100%;
            height: 100%;
        }

        .photo-container {
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .photo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 70px;
            z-index: 10;
            filter: drop-shadow(0 5px 8px rgba(0, 0, 0, 0.2));
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: #ffffff;
            border-radius: 50%;
            z-index: 5;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border: 6px solid #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
            font-size: 2rem;
        }

        .result {
            margin-top: 10px;
            font-size: 1.2rem;
            text-align: center;
            min-height: 40px;
            padding: 8px 20px;
            background: #f8f8f8;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            max-width: 500px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .sector-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            z-index: 2;
            pointer-events: none;
            background: transparent;
            box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.05);
        }

        .winner-highlight {
            animation: winnerGlow 0.5s infinite alternate;
        }

        /* Watermark Styles */
        .watermark {
            position: fixed;
            bottom: 15px;
            right: 15px;
            z-index: 1000;
            opacity: 0.7;
        }

        .watermark-img {
            max-width: 120px;
            max-height: 40px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .watermark-text {
            color: #666;
            font-size: 0.8rem;
            text-align: right;
            font-style: italic;
        }

        /* Status overlay */
        .status-overlay {
            position: fixed;
            top: 15px;
            left: 15px;
            background: rgba(255, 65, 108, 0.1);
            color: #ff416c;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 100;
            border-left: 3px solid #ff416c;
        }

        @keyframes winnerGlow {
            from {
                box-shadow: 0 0 8px rgba(255, 65, 108, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 65, 108, 0.8);
            }
        }

        @media (max-width: 600px) {
            .wheel-container {
                width: 320px;
                height: 320px;
            }
            
            .watermark {
                bottom: 10px;
                right: 10px;
            }
            
            .watermark-img {
                max-width: 100px;
                max-height: 30px;
            }
            
            .status-overlay {
                top: 10px;
                left: 10px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Status overlay -->
    <div class="status-overlay" id="statusOverlay">
        <i class="fas fa-sync-alt"></i> <span id="statusText">Loading...</span>
    </div>

    <!-- Main wheel -->
    <div class="wheel-container">
        <div class="pointer">
            <svg viewBox="0 0 100 100">
                <polygon points="50,0 65,100 35,100" fill="#ff416c"/>
                <circle cx="50" cy="85" r="8" fill="#ffffff"/>
            </svg>
        </div>
        
        <div class="wheel" id="wheel">
            <!-- Wheel sectors will be generated dynamically -->
        </div>
        
        <div class="center-circle">
            <i class="fas fa-star"></i>
        </div>
    </div>
    
    <!-- Result display -->
    <div class="result" id="result">
        Initializing...
    </div>

    <!-- Watermark container -->
    <div id="watermarkContainer" class="watermark"></div>

    <script>
        /* Injected at runtime by GitHub Actions */
        window.__SPIN_PAYLOAD__ = window.__SPIN_PAYLOAD__ || {
          users: [],
          watermark: "Spin Wheel"
        };

        class SpinToStopWheel {
            constructor() {
                // ===== SPIN-TO-STOP CONFIGURATION =====
                // Total duration for FFMPEG capture: 2 seconds
                this.SPIN_DURATION = 2000; // 2000ms = 2 seconds total
                this.START_SPEED = 25;     // Initial rotation speed
                this.END_SPEED = 0.5;      // Final speed threshold to stop
                this.DECELERATION = 0.92;  // Slowdown rate (0.92 = 8% reduction per frame)
                // ======================================
                
                this.photos = [];
                this.isSpinning = false;
                this.rotation = 0;
                this.currentSpeed = 0;
                this.animationFrame = null;
                this.spinStartTime = 0;
                this.selectedPhotoIndex = null;
                
                this.initializeElements();
                this.loadWatermarkFromParams();
                this.loadUsersFromPayload();
            }
            
            initializeElements() {
                this.wheel = document.getElementById('wheel');
                this.result = document.getElementById('result');
                this.statusOverlay = document.getElementById('statusOverlay');
                this.statusText = document.getElementById('statusText');
                this.watermarkContainer = document.getElementById('watermarkContainer');
            }
            
            // Load users from payload
            loadUsersFromPayload() {
                try {
                    this.statusText.textContent = 'Loading users...';
                    
                    const payload = window.__SPIN_PAYLOAD__;

                    if (!payload || !Array.isArray(payload.users)) {
                        throw new Error("Invalid spin payload");
                    }

                    this.photos = payload.users.map((u, i) => ({
                        id: u.userId,
                        userId: u.userId,
                        url: u.photo_url,
                        index: i + 1
                    }));

                    if (this.photos.length < 1) {
                        throw new Error("No users provided");
                    }

                    this.statusText.textContent = `${this.photos.length} users loaded`;
                    this.updateWheel();

                    console.log("Users loaded from payload:", this.photos);

                    // Start spinning immediately
                    setTimeout(() => {
                        this.startSpinToStop();
                    }, 500);
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.statusText.textContent = 'Using default users';
                    this.addDefaultPhotos();
                    this.updateWheel();
                    
                    setTimeout(() => {
                        this.startSpinToStop();
                    }, 1000);
                }
            }
            
            // Start the spin-to-stop animation
            startSpinToStop() {
                if (this.isSpinning) return;
                
                if (this.photos.length < 2) {
                    this.result.innerHTML = 'Need at least 2 users';
                    return;
                }
                
                this.isSpinning = true;
                this.currentSpeed = this.START_SPEED;
                this.spinStartTime = Date.now();
                this.statusText.textContent = 'Spinning...';
                this.result.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Spinning...';
                
                // Start animation loop
                this.animateSpin();
                
                // Auto-stop after SPIN_DURATION
                setTimeout(() => {
                    if (this.isSpinning) {
                        this.stopSpinning();
                    }
                }, this.SPIN_DURATION);
            }
            
            // Animation loop for smooth spinning
            animateSpin() {
                if (!this.isSpinning) return;
                
                // Update rotation
                this.rotation += this.currentSpeed;
                this.wheel.style.transform = `rotate(${this.rotation}deg)`;
                
                // Gradually slow down
                this.currentSpeed *= this.DECELERATION;
                
                // Continue animation if still spinning
                if (this.currentSpeed > this.END_SPEED) {
                    this.animationFrame = requestAnimationFrame(() => this.animateSpin());
                } else {
                    this.finalStop();
                }
            }
            
            // Force stop after duration
            stopSpinning() {
                if (!this.isSpinning) return;
                
                this.isSpinning = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                this.finalStop();
            }
            
            // Final stop and show result
            finalStop() {
                this.isSpinning = false;
                this.statusText.textContent = 'Stopped';
                
                // Calculate winner
                const normalizedRotation = ((this.rotation % 360) + 360) % 360;
                const degreesPerSector = 360 / this.photos.length;
                const adjustedRotation = (360 - normalizedRotation) % 360;
                const sectorIndex = Math.floor(adjustedRotation / degreesPerSector);
                
                this.selectedPhotoIndex = sectorIndex;
                const selectedUser = this.photos[sectorIndex];
                
                // Show result
                this.result.innerHTML = `ðŸŽ‰ <strong>${selectedUser.userId}</strong> ðŸŽ‰`;
                
                // Highlight winner
                this.highlightSelectedSector(sectorIndex);
                
                // Log timing info
                const totalTime = Date.now() - this.spinStartTime;
                console.log(`Spin-to-stop completed in ${totalTime}ms`);
                console.log(`Winner: User ${selectedUser.userId}`);
            }
            
            // Highlight winning sector
            highlightSelectedSector(sectorIndex) {
                const photoContainers = document.querySelectorAll('.photo-container');
                photoContainers.forEach(container => {
                    container.classList.remove('winner-highlight');
                });
                
                if (photoContainers[sectorIndex]) {
                    photoContainers[sectorIndex].classList.add('winner-highlight');
                }
            }
            
            // Update wheel display
            updateWheel() {
                this.wheel.innerHTML = '';
                
                if (this.photos.length === 0) {
                    this.result.innerHTML = 'No users loaded';
                    return;
                }
                
                const colors = this.generateDistinctColors(this.photos.length);
                const totalPhotos = this.photos.length;
                const anglePerSector = 360 / totalPhotos;
                
                // Create gradient background
                const baseWheel = document.createElement('div');
                baseWheel.className = 'wheel-sector';
                
                let conicGradient = 'conic-gradient(';
                for (let i = 0; i < totalPhotos; i++) {
                    const startAngle = i * anglePerSector;
                    const endAngle = startAngle + anglePerSector;
                    conicGradient += `${colors[i]} ${startAngle}deg ${endAngle}deg`;
                    if (i < totalPhotos - 1) {
                        conicGradient += ', ';
                    }
                }
                conicGradient += ')';
                
                baseWheel.style.background = conicGradient;
                this.wheel.appendChild(baseWheel);
                
                // Add user photos
                for (let i = 0; i < totalPhotos; i++) {
                    const user = this.photos[i];
                    const color = colors[i];
                    
                    const sectorContent = document.createElement('div');
                    sectorContent.className = 'sector-content';
                    
                    const startAngle = i * anglePerSector;
                    const midAngle = startAngle + (anglePerSector / 2);
                    
                    const radius = this.calculatePhotoRadius(totalPhotos);
                    const radian = (midAngle - 90) * Math.PI / 180;
                    const x = 50 + radius * Math.cos(radian);
                    const y = 50 + radius * Math.sin(radian);
                    
                    const photoSize = this.calculatePhotoSize(totalPhotos);
                    
                    const photoContainer = document.createElement('div');
                    photoContainer.className = 'photo-container';
                    photoContainer.style.width = `${photoSize}px`;
                    photoContainer.style.height = `${photoSize}px`;
                    photoContainer.dataset.index = i;
                    photoContainer.title = `User: ${user.userId}`;
                    
                    const photoImg = document.createElement('img');
                    photoImg.className = 'photo';
                    photoImg.src = user.url;
                    photoImg.alt = `User ${user.userId}`;
                    photoImg.onerror = function() {
                        this.src = 'data:image/svg+xml;base64,' + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="${photoSize}" height="${photoSize}" viewBox="0 0 ${photoSize} ${photoSize}">
                                <circle cx="${photoSize/2}" cy="${photoSize/2}" r="${photoSize/2}" fill="#666"/>
                                <text x="${photoSize/2}" y="${photoSize/2 + 5}" text-anchor="middle" fill="white" font-size="${photoSize/4}">${user.userId.substring(0, 6)}</text>
                            </svg>
                        `);
                    };
                    
                    photoContainer.appendChild(photoImg);
                    sectorContent.appendChild(photoContainer);
                    
                    sectorContent.style.transform = `translate(-50%, -50%) rotate(${midAngle + 90}deg)`;
                    sectorContent.style.left = `${x}%`;
                    sectorContent.style.top = `${y}%`;
                    
                    this.wheel.appendChild(sectorContent);
                }
                
                // Add decorative elements
                const sectorBorder = document.createElement('div');
                sectorBorder.className = 'sector-border';
                this.wheel.appendChild(sectorBorder);
                
                const centerCircle = document.createElement('div');
                centerCircle.className = 'center-circle';
                centerCircle.innerHTML = '<i class="fas fa-star"></i>';
                this.wheel.appendChild(centerCircle);
                
                this.result.innerHTML = `Loaded ${this.photos.length} users`;
            }
            
            // Load watermark from URL
            loadWatermarkFromParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const watermarkParamNames = ['watermark', 'wm', 'logo', 'brand', 'image'];
                let watermarkUrl = null;
                
                for (const paramName of watermarkParamNames) {
                    if (urlParams.has(paramName)) {
                        watermarkUrl = urlParams.get(paramName);
                        break;
                    }
                }
                
                if (watermarkUrl) {
                    this.createWatermark(watermarkUrl);
                } else {
                    this.createTextWatermark();
                }
            }
            
            createWatermark(url) {
                let cleanUrl = url.trim();
                try {
                    new URL(cleanUrl);
                    const img = document.createElement('img');
                    img.className = 'watermark-img';
                    img.src = cleanUrl;
                    img.alt = 'Watermark';
                    this.watermarkContainer.appendChild(img);
                } catch (error) {
                    this.createTextWatermark(cleanUrl);
                }
            }
            
            createTextWatermark(text = null) {
                if (!text) {
                    const urlParams = new URLSearchParams(window.location.search);
                    text = urlParams.get('text') || urlParams.get('name') || 'Spin Wheel';
                }
                const textDiv = document.createElement('div');
                textDiv.className = 'watermark-text';
                textDiv.textContent = text;
                this.watermarkContainer.appendChild(textDiv);
            }
            
            // Helper methods
            generateDistinctColors(count) {
                const colors = [];
                const hueStep = 360 / count;
                for (let i = 0; i < count; i++) {
                    const hue = (i * hueStep) % 360;
                    const saturation = 70 + Math.random() * 20;
                    const lightness = 60 + Math.random() * 15;
                    colors.push(this.hslToHex(hue, saturation, lightness));
                }
                return colors;
            }
            
            hslToHex(h, s, l) {
                h /= 360; s /= 100; l /= 100;
                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const hue2rgb = (p, q, t) => {
                        if (t < 0) t += 1;
                        if (t > 1) t -= 1;
                        if (t < 1/6) return p + (q - p) * 6 * t;
                        if (t < 1/2) return q;
                        if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    };
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                const toHex = x => {
                    const hex = Math.round(x * 255).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                };
                return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
            }
            
            calculatePhotoSize(photoCount) {
                if (photoCount > 16) return 40;
                if (photoCount > 12) return 50;
                if (photoCount > 8) return 60;
                if (photoCount > 4) return 70;
                return 80;
            }
            
            calculatePhotoRadius(photoCount) {
                if (photoCount > 16) return 42;
                if (photoCount > 12) return 40;
                if (photoCount > 8) return 38;
                if (photoCount > 4) return 35;
                return 32;
            }
            
            addDefaultPhotos() {
                this.photos = [
                    { id: "8052864919", url: "https://tmpfiles.org/dl/18010306/8052864919.jpg", userId: "8052864919" },
                    { id: "6702069974", url: "https://tmpfiles.org/dl/18010304/6702069974.jpg", userId: "6702069974" },
                    { id: "6407458800", url: "https://tmpfiles.org/dl/18010305/6407458800.jpg", userId: "6407458800" }
                ];
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.spinWheel = new SpinToStopWheel();
            
            console.log('=== SPIN-TO-STOP WHEEL ===');
            console.log('Configured for 2-second FFMPEG capture');
            console.log('Users loaded from window.__SPIN_PAYLOAD__');
            console.log('Payload format: {users: [{userId:"123",photo_url:"https://..."}]}');
        });
    </script>
</body>
</html>
